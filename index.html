<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ChongChi‚Äôs Menu - iOS Fix</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body { font-family: 'Nunito', sans-serif; background-color: #f0f2f5; padding-bottom: 100px; }
        .header-title { color: #d63031; font-weight: 800; text-shadow: 2px 2px 0px rgba(0,0,0,0.1); }
        
        /* CARD M√ìN ƒÇN */
        .dish-card {
            cursor: pointer; transition: all 0.2s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: none; background: white; border-radius: 12px; 
            overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            height: 100%; position: relative;
        }
        .dish-card:hover { transform: translateY(-3px); box-shadow: 0 12px 20px rgba(0,0,0,0.15); }
        .dish-card:active { transform: scale(0.98); }
        
        .dish-img { width: 100%; height: 130px; object-fit: cover; border-bottom: 1px solid #f0f0f0; transition: 0.3s; }
        .dish-name { font-weight: 700; font-size: 0.9rem; color: #2d3436; margin: 0; line-height: 1.3; }

        /* Active State */
        .dish-card.active-dish { box-shadow: 0 0 0 3px #d63031; }
        .dish-card.active-dish .dish-img { filter: brightness(0.5); }
        .dish-card.active-dish::after {
            content: '\f00c'; font-family: "Font Awesome 6 Free"; font-weight: 900;
            position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-size: 2.5rem; z-index: 10; text-shadow: 0 2px 10px rgba(0,0,0,0.5); pointer-events: none;
        }

        /* UI CHUNG */
        .sticky-sidebar { position: sticky; top: 20px; z-index: 50; }
        .result-box { background: white; border-radius: 12px; border-top: 5px solid #d63031; }
        .category-header { border-left: 5px solid #d63031; padding-left: 10px; color: #2d3436; margin: 25px 0 15px 0; font-weight: 800; font-size: 1.3rem; }
        .search-box { position: relative; margin-bottom: 20px; }
        .search-box input { padding-left: 40px; border-radius: 25px; border: 1px solid #ced4da; }
        .search-box i { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: #aaa; }
        .btn-random { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border: none; }
        .btn-edit-note { border: none; background: none; color: #aaa; transition: 0.2s; padding: 0 5px; }
        .btn-edit-note:hover { color: #d63031; transform: scale(1.1); }

        /* Dropdown & Toast */
        .dropdown-item { padding: 10px 20px; font-weight: 600; cursor: pointer; }
        .dropdown-item:hover { background-color: #fff1f0; color: #d63031; }
        .dropdown-item i { width: 25px; text-align: center; margin-right: 10px; }
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 1060; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .ant-toast { background: white; padding: 10px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); display: flex; align-items: center; gap: 10px; font-weight: 600; animation: slideDown 0.3s ease forwards; pointer-events: auto; }
        .ant-toast.success { color: #52c41a; border-left: 4px solid #52c41a; }
        .ant-toast.error { color: #ff4d4f; border-left: 4px solid #ff4d4f; }
        .ant-toast.info { color: #1890ff; border-left: 4px solid #1890ff; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        /* Table Custom */
        .table-custom th:nth-child(1), .table-custom td:nth-child(1) { width: 15%; white-space: nowrap; }
        .table-custom th:nth-child(2), .table-custom td:nth-child(2) { width: 70%; }
        .table-custom th:nth-child(3), .table-custom td:nth-child(3) { width: 15%; text-align: center; }
    </style>
</head>
<body>

    <div id="toast-container"></div>

    <div class="container py-4">
        <div class="text-center mb-5">
            <h1 class="header-title display-4"><i class="fas fa-utensils me-2"></i>ChongChi‚Äôs Menu</h1>
            <p class="text-muted fs-5">Th·ª±c ƒë∆°n c∆°m nh√† cho <b>Ch·ªã Hai & Anh Bo</b> ‚ù§Ô∏è</p>
        </div>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="form-control form-control-lg" id="search-input" placeholder="T√¨m m√≥n..." onkeyup="filterMenu()">
                </div>

                <h3 class="category-header"><i class="fas fa-drumstick-bite me-2 text-danger"></i>M√≥n Ch√≠nh</h3>
                <div class="row row-cols-2 row-cols-md-3 g-3" id="list-main"></div>

                <h3 class="category-header"><i class="fas fa-leaf me-2 text-success"></i>M√≥n X√†o</h3>
                <div class="row row-cols-2 row-cols-md-3 g-3" id="list-stir"></div>

                <h3 class="category-header"><i class="fas fa-mug-hot me-2 text-primary"></i>Canh</h3>
                <div class="row row-cols-2 row-cols-md-3 g-3" id="list-soup"></div>
            </div>

            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    <div class="result-box shadow p-4" id="ticket-area">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="m-0 fw-bold"><i class="fas fa-clipboard-check me-2"></i>Th·ª±c ƒë∆°n</h4>
                            <button onclick="resetMenuWithNotify()" class="btn btn-sm btn-outline-secondary rounded-pill px-3 btn-reset"><i class="fas fa-redo"></i> Reset</button>
                        </div>
                        <hr>
                        
                        <button onclick="randomizeMenu()" class="btn btn-random w-100 mb-3 fw-bold py-2 rounded-3 shadow-sm btn-random">
                            <i class="fas fa-dice me-2"></i>H√¥m nay ƒÉn g√¨?
                        </button>

                        <div class="mb-3 bg-light p-2 rounded border border-dashed">
                            <label class="form-label small fw-bold text-muted mb-1"><i class="far fa-calendar-alt me-1"></i>Ng√†y ƒÉn:</label>
                            <input type="date" id="menu-date" class="form-control fw-bold text-center border-0 bg-transparent">
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small fw-bold">M√ìN CH√çNH:</label>
                            <div id="res-main" class="fs-5">Ch∆∞a ch·ªçn</div>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small fw-bold">M√ìN X√ÄO:</label>
                            <div id="res-stir" class="fs-5">Kh√¥ng c√≥</div>
                        </div>

                        <div class="mb-4">
                            <label class="text-muted small fw-bold">CANH:</label>
                            <div id="res-soup" class="fs-5">Ch∆∞a ch·ªçn</div>
                        </div>

                        <div class="btn-group w-100 btn-export-group">
                            <button type="button" class="btn btn-dark py-3 fw-bold dropdown-toggle rounded-3" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-save me-2"></i>L∆∞u & T√πy ch·ªçn...
                            </button>
                            <ul class="dropdown-menu w-100 shadow border-0 mt-1">
                                <li><a class="dropdown-item" onclick="processExport('pdf')">
                                    <i class="fas fa-file-pdf text-danger"></i> Xu·∫•t file PDF
                                </a></li>
                                <li><a class="dropdown-item" onclick="processExport('clipboard')">
                                    <i class="fas fa-copy text-primary"></i> Copy ·∫£nh (Desktop)
                                </a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" onclick="processExport('image')">
                                    <i class="fas fa-images text-success"></i> L∆∞u ·∫£nh (Mobile)
                                </a></li>
                            </ul>
                        </div>

                    </div>
                </div>
            </div>
        </div>

        <div class="history-section mt-5 bg-white p-4 rounded-4 shadow-sm" id="history-section">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="fw-bold m-0"><i class="fas fa-history me-2 text-warning"></i>L·ªãch s·ª≠</h4>
                <button data-bs-toggle="modal" data-bs-target="#confirmDeleteAllModal" class="btn btn-outline-danger btn-sm rounded-pill">X√≥a t·∫•t c·∫£</button>
            </div>
            <div class="table-responsive">
                <table class="table table-hover align-middle table-custom">
                    <thead class="table-light"><tr><th>Ng√†y</th><th>Chi ti·∫øt th·ª±c ƒë∆°n</th><th class="text-center">Thao t√°c</th></tr></thead>
                    <tbody id="history-body"></tbody>
                </table>
                <p id="empty-msg" class="text-center text-muted mt-3" style="display:none;">Ch∆∞a c√≥ l·ªãch s·ª≠.</p>
            </div>
        </div>
    </div>

    <div class="modal fade" id="resultImageModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <h5 class="modal-title fw-bold text-success"><i class="fas fa-check-circle me-2"></i>ƒê√£ t·∫°o ·∫£nh xong!</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <div class="bg-light p-3">
                        <img id="final-result-img" src="" class="img-fluid shadow-sm rounded border" alt="Ket qua">
                    </div>
                    <div class="p-3">
                        <p class="mb-0 fw-bold text-primary blink-text">üëá Nh·∫•n gi·ªØ v√†o ·∫£nh ƒë·ªÉ L∆∞u v√†o Th∆∞ vi·ªán</p>
                        <small class="text-muted">(Ho·∫∑c ch·ªçn "Th√™m v√†o ·∫¢nh" tr√™n iOS)</small>
                    </div>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-secondary rounded-pill px-4" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center pt-4">
                    <h5 class="fw-bold">X√≥a d√≤ng n√†y?</h5>
                    <div class="mt-4">
                        <button type="button" class="btn btn-light rounded-pill px-4 me-2" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4" id="btn-confirm-delete">X√≥a</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="confirmDeleteAllModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center pt-4">
                    <h5 class="fw-bold text-danger">X√≥a s·∫°ch l·ªãch s·ª≠?</h5>
                    <div class="mt-4">
                        <button type="button" class="btn btn-light rounded-pill px-4 me-2" data-bs-dismiss="modal">Th√¥i</button>
                        <button type="button" class="btn btn-danger rounded-pill px-4" onclick="actionClearAllHistory()">X√≥a lu√¥n</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="noteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-sm">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="noteModalTitle">Ghi ch√∫</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="noteModalInput" class="form-control" rows="3" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
                </div>
                <div class="modal-footer border-0 pt-0">
                    <button type="button" class="btn btn-primary w-100 rounded-3 fw-bold" onclick="saveNote()">L∆∞u</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const menuData = {
            main: [
                { name: "Th·ªãt ƒë·∫≠u s·ªët c√† chua", img: "https://img-global.cpcdn.com/recipes/af4a00ea96579b35/1200x630cq80/photo.jpg" },
                { name: "Tr·ª©ng c√∫t th·ªãt s·ªët c√†", img: "https://i.ytimg.com/vi/-KzA2ZLiKg8/hq720.jpg" },
                { name: "Ba ch·ªâ rim s·∫£", img: "https://cdn.tgdd.vn/2021/10/CookRecipe/GalleryStep/thanh-pham-23.png" },
                { name: "T√¥m kho th·ªãt", img: "https://cdn.tgdd.vn/Files/2019/05/29/1169734/chi-20-phut-co-ngay-mot-noi-thit-kho-tom-cho-bua-toi-202203031510423719.jpg" },
                { name: "C√°nh g√† chi√™n m·∫Øm t·ªèi", img: "https://cdn-media.sforum.vn/storage/app/media/wp-content/uploads/2023/11/cach-lam-canh-ga-chien-nuoc-mam-thumb.jpg" },
                { name: "G√† s·ªët cay ng·ªçt", img: "https://cdn.tgdd.vn/Files/2018/12/18/1138838/cung-thuc-hien-mon-ga-cay-han-quoc-cuc-ky-dua-com-202209051440260841.jpg" },
                { name: "Th·ªãt kho tr·ª©ng c√∫t", img: "https://i.ytimg.com/vi/NjSOVey-Ri8/maxresdefault.jpg" },
                { name: "Ba ch·ªâ kho th∆°m", img: "https://i.ytimg.com/vi/QNt8TEHgaVg/hq720.jpg" },
                { name: "Th·ªãt x√†o c·∫£i chua", img: "https://cdn2.fptshop.com.vn/unsafe/Uploads/images/tin-tuc/177210/Originals/thit-xao-dua-chua-5.jpg" },
                { name: "C√° basa kho ti√™u", img: "https://daotaobeptruong.vn/wp-content/uploads/2015/12/kho-voi-tieu.jpg" },
                { name: "G√† kho s·∫£", img: "https://i.ytimg.com/vi/hT1EgTIvZpI/maxresdefault.jpg" },
                { name: "G√† kho g·ª´ng", img: "https://cdn.tgdd.vn/Files/2021/08/18/1376178/cach-lam-mon-ga-xao-gung-dam-da-ngon-com-202201071434412548.jpg" }
            ],
            stir: [
                { name: "M∆∞·ªõp x√†o", img: "https://cdn.tgdd.vn/Files/2019/07/18/1180290/chi-10-phut-co-ngay-mon-muop-xao-toi-thom-phuc-201907191139504189.jpg" },
                { name: "B·∫Øp c·∫£i x√†o c√† r·ªët", img: "https://cdn.tgdd.vn/2021/06/CookRecipe/GalleryStep/thanh-pham-340.jpg" },
                { name: "Rau mu·ªëng x√†o t·ªèi", img: "https://i-giadinh.vnecdn.net/2022/04/19/Thanh-pham-1-1-5394-1650361176.jpg" },
                { name: "Rau lang x√†o t·ªèi", img: "https://cdn2.fptshop.com.vn/unsafe/1920x0/filters:format(webp):quality(75)/2024_1_14_638408650008789264_rau-lang-xao-toi.jpeg" },
                { name: "D∆∞a leo h√†nh t√¢y th∆°m", img: "https://img-global.cpcdn.com/recipes/8575b5c7c23e8fd8/1200x630cq80/photo.jpg" },
                { name: "C·∫£i th√¨a x√†o t·ªèi", img: "https://cdn2.fptshop.com.vn/unsafe/cai_thia_xao_toi_6_d4522129e8.jpeg" },
                { name: "ƒê·∫≠u ve x√†o th·ªãt", img: "https://cdn.tgdd.vn/Files/2021/10/19/1391680/mach-ban-cong-thuc-lam-cat-heo-xao-dau-que-vua-don-gian-lai-hap-dan-202110192021015436.jpg" },
                { name: "Tr·ª©ng chi√™n", img: "https://cdn.tgdd.vn/2021/01/CookProduct/Tong-hop-15-cach-lam-trung-chien-ngon-don-gian-hap-dan-de-lam-cho-bua-com-1-1200x676.jpg" },
                { name: "C·∫£i ng·ªìng x√†o", img: "https://assets.tmecosys.com/image/upload/t_web_rdp_recipe_584x480/img/recipe/ras/Assets/7fd31594f64f137971cfcc871135c3ee/Derivates/16b58f80fdf87ec9820a9f47c82b474a0162041e.jpg" }
            ],
            soup: [
                { name: "Canh chua", img: "https://www.huongnghiepaau.com/wp-content/uploads/2018/03/cach-nau-canh-chua-ca-dieu-hong.jpg" },
                { name: "Canh rau ng√≥t", img: "https://cdn2.fptshop.com.vn/unsafe/1920x0/filters:format(webp):quality(75)/rau_ngot_nau_gi_0_1_1_67bef51e63.jpg" },
                { name: "Canh m·ªìng t∆°i", img: "https://cdn2.fptshop.com.vn/unsafe/1920x0/filters:format(webp):quality(75)/2024_1_23_638415700740017413_cover.jpg" },
                { name: "Canh c·∫£i", img: "https://cdn2.fptshop.com.vn/unsafe/1920x0/filters:format(webp):quality(75)/2023_10_20_638334216677224510_canh-cai-ngot_hinh-3.jpeg" },
                { name: "Canh b·∫Øp c·∫£i", img: "https://www.cet.edu.vn/wp-content/uploads/2019/01/canh-cai-thao-nau-tom.jpg" },
                { name: "Canh rau c·ªß", img: "https://cdn2.fptshop.com.vn/unsafe/1920x0/filters:format(webp):quality(75)/2023_12_16_638383434750276787_cac-cong-thuc-canh-rau-cu-thap-cam-thanh-dam-giau-dinh-duong-de-doi-mon-cho-bua-an-gia-dinh.jpg" },
                { name: "Canh rau mu·ªëng", img: "https://cdn.tgdd.vn/Files/2021/03/25/1338192/8-cach-nau-canh-rau-muong-ngon-de-lam-202103282330456326.jpg" },
                { name: "Canh rau lang", img: "https://cdn.tgdd.vn/2021/06/CookRecipe/GalleryStep/thanh-pham-514.jpg" },
                { name: "Canh khoai m·ª°", img: "https://www.cet.edu.vn/wp-content/uploads/2018/05/canh-khoai-mo.jpg" },
                { name: "Canh rau d·ªÅn", img: "https://vcdn1-giadinh.vnecdn.net/2013/08/19/canh-rau-5-1376882043-1376882169.jpg?w=680&h=0&q=100&dpr=2&fit=crop&s=wADMH14ivty-z_HK8gCgAA" },
                { name: "Canh b·∫ßu t√¥m", img: "https://cdn.tgdd.vn/Files/2019/12/09/1225795/cach-lam-canh-bau-nau-tom-de-lam-vung-may-cung-lam-duoc-202203171431040419.jpg" },
                { name: "Canh b√≠ ƒëao", img: "https://www.huongnghiepaau.com/wp-content/uploads/2025/02/3-cach-nau-canh-bi-dao-thanh-mat.jpg" }
            ]
        };

        // --- INIT VARS ---
        document.getElementById('menu-date').valueAsDate = new Date();
        let selected = { main: null, stir: null, soup: null };
        const deleteModal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
        const deleteAllModal = new bootstrap.Modal(document.getElementById('confirmDeleteAllModal'));
        const noteModal = new bootstrap.Modal(document.getElementById('noteModal'));
        const resultImageModal = new bootstrap.Modal(document.getElementById('resultImageModal'));
        let currentEditingType = null;
        let deleteTargetId = null;

        // --- RENDER ---
        function renderMenu() {
            const createHTML = (items, type) => items.map(item => `
                <div class="col dish-col">
                    <div class="card dish-card shadow-sm h-100" id="card-${type}-${item.name.replace(/\s/g, '')}" onclick="toggleItem('${type}', '${item.name}')">
                        <img src="${item.img}" class="dish-img" alt="${item.name}" loading="lazy">
                        <div class="card-body p-2 text-center d-flex align-items-center justify-content-center" style="min-height: 60px;">
                            <p class="dish-name">${item.name}</p>
                        </div>
                    </div>
                </div>`).join('');
            document.getElementById('list-main').innerHTML = createHTML(menuData.main, 'main');
            document.getElementById('list-stir').innerHTML = createHTML(menuData.stir, 'stir');
            document.getElementById('list-soup').innerHTML = createHTML(menuData.soup, 'soup');
            renderHistory();
            updateUI(); 
        }

        // --- CORE LOGIC ---
        function toggleItem(type, name) {
            if (selected[type] && selected[type].name === name) {
                selected[type] = null;
            } else if (selected[type] === null) {
                selected[type] = { name: name, note: "" };
            } else {
                showToast(`Ch·ªâ ƒë∆∞·ª£c ch·ªçn 1 m√≥n ${type === 'main' ? 'Ch√≠nh' : (type === 'stir' ? 'X√†o' : 'Canh')}!`, 'error');
                return; 
            }
            updateUI();
        }

        function updateUI() {
            document.querySelectorAll('.dish-card').forEach(c => c.classList.remove('active-dish'));
            ['main', 'stir', 'soup'].forEach(type => {
                const item = selected[type];
                if (item) {
                    const cardId = `card-${type}-${item.name.replace(/\s/g, '')}`;
                    const card = document.getElementById(cardId);
                    if (card) card.classList.add('active-dish');
                }
            });
            updateResultText();
        }

        function updateResultText() {
            const renderItemText = (item, type) => {
                if (!item) return `<span class="text-muted fw-bold">Ch∆∞a ch·ªçn</span>`;
                let textClass = type === 'main' ? 'text-danger' : (type === 'stir' ? 'text-success' : 'text-primary');
                if(!item.name) return `<span class="${textClass} fw-bold">Kh√¥ng c√≥</span>`;
                return `
                    <div class="d-flex justify-content-between align-items-start">
                        <span class="${textClass} fw-bold">${item.name}</span>
                        <button class="btn-edit-note" onclick="openNoteModal('${type}')" title="S·ª≠a ghi ch√∫"><i class="fas fa-pen"></i></button>
                    </div>
                    ${item.note ? `<div class="text-muted fst-italic small mt-1 ps-2 border-start border-2">${item.note}</div>` : ''}
                `;
            };
            document.getElementById('res-main').innerHTML = selected.main ? renderItemText(selected.main, 'main') : "Ch∆∞a ch·ªçn";
            document.getElementById('res-stir').innerHTML = selected.stir ? renderItemText(selected.stir, 'stir') : "Kh√¥ng c√≥";
            document.getElementById('res-soup').innerHTML = selected.soup ? renderItemText(selected.soup, 'soup') : "Ch∆∞a ch·ªçn";
        }

        // --- NOTE LOGIC ---
        function openNoteModal(type) {
            if (!selected[type]) return;
            currentEditingType = type;
            const item = selected[type];
            document.getElementById('noteModalTitle').innerText = `Ghi ch√∫: ${item.name}`;
            document.getElementById('noteModalInput').value = item.note || "";
            noteModal.show();
        }
        function saveNote() {
            if (currentEditingType && selected[currentEditingType]) {
                const newNote = document.getElementById('noteModalInput').value;
                selected[currentEditingType].note = newNote;
                updateResultText();
                noteModal.hide();
                showToast("ƒê√£ l∆∞u ghi ch√∫!", "info");
            }
        }

        // --- UTILS ---
        function filterMenu() {
            const input = document.getElementById('search-input').value.toLowerCase();
            document.querySelectorAll('.dish-col').forEach(col => {
                const text = col.querySelector('.dish-name').innerText.toLowerCase();
                col.style.display = text.includes(input) ? "block" : "none";
            });
        }
        function randomizeMenu() {
            selected = { main: null, stir: null, soup: null };
            const pick = (arr) => arr.length > 0 ? arr[Math.floor(Math.random() * arr.length)].name : null;
            if(pick(menuData.main)) selected.main = { name: pick(menuData.main), note: "" };
            if(pick(menuData.stir)) selected.stir = { name: pick(menuData.stir), note: "" };
            if(pick(menuData.soup)) selected.soup = { name: pick(menuData.soup), note: "" };
            updateUI();
            showToast('ƒê√£ ch·ªçn m√≥n ng·∫´u nhi√™n!', 'info');
        }
        function resetMenuWithNotify() { selected = { main: null, stir: null, soup: null }; updateUI(); showToast('ƒê√£ l√†m m·ªõi!', 'info'); }
        function showToast(msg, type='success') {
            const t = document.createElement('div');
            let icon = type === 'error' ? 'fa-times-circle' : (type === 'info' ? 'fa-info-circle' : 'fa-check-circle');
            t.className = `ant-toast ${type}`;
            t.innerHTML = `<i class="fas ${icon}"></i><span>${msg}</span>`;
            document.getElementById('toast-container').appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }

        // --- HISTORY ---
        function getHistory() { return JSON.parse(localStorage.getItem('menu_history') || '[]'); }
        function saveToHistory() {
            const dateInput = document.getElementById('menu-date').value;
            const parts = dateInput.split("-");
            const dateFormatted = `${parts[2]}/${parts[1]}/${parts[0]}`;
            const formatData = (item) => item ? (item.note ? `${item.name} (${item.note})` : item.name) : "";
            const item = { 
                id: Date.now(), 
                date: dateFormatted, dateRaw: dateInput,
                main: formatData(selected.main), stir: formatData(selected.stir), soup: formatData(selected.soup),
                rawData: JSON.parse(JSON.stringify(selected)) 
            };
            localStorage.setItem('menu_history', JSON.stringify([item, ...getHistory()]));
            renderHistory();
        }
        function renderHistory() {
            const h = getHistory();
            const tbody = document.getElementById('history-body');
            if (h.length === 0) { tbody.innerHTML = ''; document.getElementById('empty-msg').style.display = 'block'; return; }
            document.getElementById('empty-msg').style.display = 'none';
            tbody.innerHTML = h.map(i => `
                <tr>
                    <td class="fw-bold text-muted">${i.date}</td>
                    <td><small>
                        <span class="text-danger">Ch√≠nh:</span> ${i.main || "---"}<br>
                        <span class="text-success">X√†o:</span> ${i.stir || "---"}<br>
                        <span class="text-primary">Canh:</span> ${i.soup || "---"}
                    </small></td>
                    <td>
                        <button onclick="viewHistory(${i.id})" class="btn btn-sm btn-outline-primary border-0 me-1" title="Xem l·∫°i"><i class="fas fa-eye"></i></button>
                        <button onclick="openDeleteModal(${i.id})" class="btn btn-sm btn-outline-danger border-0" title="X√≥a"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
        }
        function viewHistory(id) {
            const item = getHistory().find(i => i.id === id);
            if (item && item.rawData) {
                selected = item.rawData;
                if(item.dateRaw) document.getElementById('menu-date').value = item.dateRaw;
                updateUI(); window.scrollTo({ top: 0, behavior: 'smooth' }); showToast('ƒê√£ xem l·∫°i th·ª±c ƒë∆°n c≈©!', 'info');
            }
        }
        function openDeleteModal(id) { deleteTargetId = id; deleteModal.show(); }
        document.getElementById('btn-confirm-delete').addEventListener('click', function() {
            if (deleteTargetId) {
                localStorage.setItem('menu_history', JSON.stringify(getHistory().filter(x => x.id !== deleteTargetId)));
                renderHistory(); deleteModal.hide(); showToast('ƒê√£ x√≥a th√†nh c√¥ng!');
            }
        });
        function actionClearAllHistory() { localStorage.removeItem('menu_history'); renderHistory(); deleteAllModal.hide(); showToast('ƒê√£ d·ªçn s·∫°ch l·ªãch s·ª≠!'); }

        // --- EXPORT LOGIC ---
        function processExport(type) {
            if(!selected.main && !selected.soup) return showToast('Ch∆∞a ch·ªçn m√≥n n√†o!', 'error');
            saveToHistory();

            const btnGroup = document.querySelector('.btn-export-group');
            const randomBtn = document.querySelector('.btn-random');
            const editBtns = document.querySelectorAll('.btn-edit-note');
            const resetBtn = document.querySelector('.btn-reset');
            
            if(btnGroup) btnGroup.style.display = 'none'; 
            if(randomBtn) randomBtn.style.display = 'none';
            if(resetBtn) resetBtn.style.display = 'none';
            editBtns.forEach(b => b.style.display = 'none');

            const dateInput = document.getElementById('menu-date');
            const originalValue = dateInput.value; 
            let dateDisplayHtml = "";
            if(originalValue) {
                const parts = originalValue.split("-");
                dateDisplayHtml = `<div id="temp-date-display" class="fw-bold text-center fs-4">${parts[2]}/${parts[1]}/${parts[0]}</div>`;
            } else {
                const today = new Date();
                dateDisplayHtml = `<div id="temp-date-display" class="fw-bold text-center fs-4">${today.getDate()}/${today.getMonth()+1}/${today.getFullYear()}</div>`;
            }
            dateInput.style.display = 'none';
            dateInput.insertAdjacentHTML('afterend', dateDisplayHtml);
            
            const dateStr = originalValue || "Menu";
            const element = document.getElementById('ticket-area');

            if (type === 'pdf') {
                html2pdf().set({
                    margin: 0.5, filename: `ThucDon_${dateStr}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, scrollY: 0 },
                    jsPDF: { unit: 'in', format: 'a5' }
                }).from(element).save().then(() => restoreUI());
            } 
            else if (type === 'clipboard') {
                html2canvas(element, { scale: 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
                    canvas.toBlob(async function(blob) {
                        try {
                            const item = new ClipboardItem({ "image/png": blob });
                            await navigator.clipboard.write([item]);
                            showToast('ƒê√£ Copy ·∫£nh! Ctrl+V ƒë·ªÉ g·ª≠i.', 'success');
                        } catch(err) {
                            showToast('Kh√¥ng h·ªó tr·ª£ copy ·∫£nh. ƒê√£ t·∫£i v·ªÅ m√°y.', 'info');
                            downloadImage(canvas, dateStr);
                        }
                        restoreUI();
                    });
                });
            }
            else if (type === 'image') {
                // HI·ªÇN TH·ªä MODAL CHO MOBILE
                html2canvas(element, { scale: 2, useCORS: true, backgroundColor: "#ffffff" }).then(canvas => {
                    const imgData = canvas.toDataURL("image/png");
                    document.getElementById('final-result-img').src = imgData;
                    resultImageModal.show();
                    restoreUI();
                });
            }

            function restoreUI() {
                if(btnGroup) btnGroup.style.display = 'inline-flex';
                if(randomBtn) randomBtn.style.display = 'block';
                if(resetBtn) resetBtn.style.display = 'block';
                editBtns.forEach(b => b.style.display = 'inline-block');
                const tempDate = document.getElementById('temp-date-display');
                if(tempDate) tempDate.remove();
                dateInput.style.display = 'block';
                
                selected = { main: null, stir: null, soup: null };
                updateUI();
            }

            function downloadImage(canvas, name) {
                const link = document.createElement('a');
                link.download = `ThucDon_${name}.png`;
                link.href = canvas.toDataURL();
                link.click();
            }
        }

        renderMenu();
    </script>
</body>
</html>